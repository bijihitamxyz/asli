name: Facebook Auto Comment Bot

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
    # Run at 9 AM and 9 PM WIB (2 AM and 2 PM UTC)
    - cron: '0 2,14 * * *'
  
  workflow_dispatch:
    inputs:
      target_feed:
        description: 'Target Feed'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - friends
          - videos
          - groups
      comment_limit:
        description: 'Comment Limit (per feed)'
        required: false
        default: '5'
      dry_run:
        description: 'Dry Run (no actual comments)'
        required: false
        default: false
        type: boolean

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: Validate inputs
        id: check
        run: |
          if [ "${{ github.event_name }}" = "schedule" ] || [ "${{ secrets.FACEBOOK_COOKIES }}" != "" ]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
          else
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "‚ùå FACEBOOK_COOKIES secret not configured"
          fi

  run-bot:
    needs: validate-inputs
    if: needs.validate-inputs.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          # Install Puppeteer Chrome browser
          npx puppeteer browsers install chrome
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk-bridge2.0-0 \
            libx11-xcb1 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libgbm1 \
            libxss1 \
            libasound2-data \
            libasound2-plugins \
            libasound2-plugins-pulse \
            fonts-liberation \
            libappindicator3-1 \
            libdrm2 \
            libgtk-3-0 \
            libnspr4 \
            libxtst6 \
            xdg-utils
      
      - name: Create required directories and files
        run: |
          mkdir -p logs
          touch ceklink.txt
          
          # Create group_links.txt if missing
          if [ ! -f group_links.txt ]; then
            echo "https://www.facebook.com/groups/digitalmarketingindonesia" > group_links.txt
            echo "https://www.facebook.com/groups/entrepreneurindonesia" >> group_links.txt
          fi
          
          # Create comments.txt if missing
          if [ ! -f comments.txt ]; then
            echo "Nice post! üëç" > comments.txt
            echo "---" >> comments.txt
            echo "Great content!" >> comments.txt
          fi
      
      - name: Setup configuration
        run: |
          # Override target feed based on inputs
          if [ "${{ github.event.inputs.target_feed }}" = "friends" ]; then
            jq '.features = {"auto_comment_friend": true, "auto_comment_video": false, "auto_comment_group": false}' config.json > config.tmp && mv config.tmp config.json
          elif [ "${{ github.event.inputs.target_feed }}" = "videos" ]; then
            jq '.features = {"auto_comment_friend": false, "auto_comment_video": true, "auto_comment_group": false}' config.json > config.tmp && mv config.tmp config.json
          elif [ "${{ github.event.inputs.target_feed }}" = "groups" ]; then
            jq '.features = {"auto_comment_friend": false, "auto_comment_video": false, "auto_comment_group": true}' config.json > config.tmp && mv config.tmp config.json
          fi
          
          # Override comment limits if specified
          if [ "${{ github.event.inputs.comment_limit }}" != "" ]; then
            LIMIT="${{ github.event.inputs.comment_limit }}"
            jq --arg limit "$LIMIT" '.comment_limits = {"friends_feed": ($limit | tonumber), "video_feed": ($limit | tonumber), "group_feed": ($limit | tonumber)}' config.json > config.tmp && mv config.tmp config.json
          fi
          echo "üìã Final configuration:"
          cat config.json
      
      - name: Setup Gemini API Keys
        run: |
          echo "${{ secrets.GEMINI_API_KEYS }}" > gemini_api_keys.txt
          KEY_COUNT=$(grep -c "^AIzaSy" gemini_api_keys.txt || echo "0")
          echo "ü§ñ Found $KEY_COUNT Gemini API keys"
          if [ "$KEY_COUNT" -eq "0" ]; then
            echo "‚ö†Ô∏è No valid Gemini API keys found"
            echo "AIzaSyDUMMY_KEY_REPLACE_WITH_REAL_ONE" > gemini_api_keys.txt
          fi
      
      - name: Setup Facebook Cookies
        run: |
          echo '${{ secrets.FACEBOOK_COOKIES }}' > cookies.json
          if jq empty cookies.json 2>/dev/null; then
            COOKIE_COUNT=$(jq '. | length' cookies.json)
            echo "üç™ Loaded $COOKIE_COUNT Facebook cookies"
          else
            echo "‚ùå Invalid cookies format"
            exit 1
          fi
      
      - name: Run test
        run: npm test
      
      - name: Run Facebook Bot
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "üß™ Dry run mode - bot will not post actual comments"
            export DRY_RUN=true
          fi
          echo "üöÄ Starting Facebook Auto Comment Bot..."
          timeout 25m npm start || echo "‚ö†Ô∏è Bot execution completed or timed out"
        env:
          FACEBOOK_COOKIES: ${{ secrets.FACEBOOK_COOKIES }}
          GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
          NODE_ENV: production
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
      
      - name: Upload bot logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bot-logs-${{ github.run_id }}
          path: |
            logs/
            ceklink.txt
          retention-days: 7
      
      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f cookies.json
          rm -f gemini_api_keys.txt
          echo "üßπ Sensitive files cleaned up"

  cleanup:
    needs: run-bot
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old artifacts
        run: |
          echo "üßπ Cleanup job completed"
